<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Math</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .input-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .input-group h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .input-group h4 {
            margin: 15px 0 10px 0;
            color: #666;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        label {
            display: block;
            margin: 10px 0 5px 0;
            font-weight: 600;
            color: #495057;
        }
        input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
            transition: background-color 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: center;
        }
        th {
            background: #007bff;
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        .negative {
            color: #dc3545;
            font-weight: bold;
        }
        .positive {
            color: #28a745;
            font-weight: bold;
        }
        .work-income {
            position: relative;
            cursor: help;
        }
        .work-income:hover {
            background-color: #e7f3ff;
        }
        .retirement-cell {
            position: relative;
            cursor: help;
        }
        .retirement-cell:hover {
            background-color: #e7f3ff;
        }
        .tooltip {
            position: absolute;
            background: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 5px;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #2c3e50;
        }
        .work-income:hover .tooltip,
        .retirement-cell:hover .tooltip {
            opacity: 1;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .summary {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .summary h3 {
            margin-top: 0;
            color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öôÔ∏è Life Math üîß</h1>
        
        <div class="inputs">
            <div class="input-group">
                <h3>Basic Information</h3>
                <label for="currentAge">Current Age:</label>
                <input type="number" id="currentAge" value="44" min="25" max="70">
                
                <label for="endAge">End Age:</label>
                <input type="number" id="endAge" value="60" min="45" max="75">
                
                <label for="startingCareerHours">Initial Ready Reserve Credited Hours:</label>
                <input type="number" id="startingCareerHours" value="9695" min="0" onchange="updateCurrentHourlyRate()">
                
                <label for="annualHours">Annual Work Hours:</label>
                <input type="number" id="annualHours" value="800" min="100" max="2080" onchange="updatePTOPayout()">
                
                <label for="startingProfitSharing">Starting Profit Sharing ($):</label>
                <input type="number" id="startingProfitSharing" value="0" min="0">
            </div>
            
            <div class="input-group">
                <h3>Income Settings</h3>
                <label for="currentHourlyRate">Current Hourly Rate ($):</label>
                <input type="number" id="currentHourlyRate" value="27.45" step="0.01" min="10" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                
                <label for="annualRaise">Annual Raise (%):</label>
                <input type="number" id="annualRaise" value="4" step="0.1" min="0" max="15">
                
                <label for="profitSharingPercent">Profit Sharing (% of W2):</label>
                <input type="number" id="profitSharingPercent" value="10" step="1" min="0" max="25">
                
                <label for="ptoPayout">PTO Payout ($):</label>
                <input type="number" id="ptoPayout" value="0" min="0" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                
                <label for="otherIncome">Other Annual Income ($):</label>
                <input type="number" id="otherIncome" value="500" min="0">
                
                <label for="partnerIncome">Partner Monthly Income ($):</label>
                <input type="number" id="partnerIncome" value="1500" min="0">
            </div>
            
            <div class="input-group">
                <h3>Expense Settings</h3>
                <h4 style="margin: 15px 0 10px 0; color: #666;">Essential Monthly Expenses</h4>
                
                <label for="rent">Rent/Mortgage ($):</label>
                <input type="number" id="rent" value="1760" min="0" onchange="updateAnnualExpenses()">
                
                <label for="pets">Pets ($):</label>
                <input type="number" id="pets" value="300" min="0" onchange="updateAnnualExpenses()">
                
                <label for="subscriptions">Subscriptions ($):</label>
                <input type="number" id="subscriptions" value="56" min="0" onchange="updateAnnualExpenses()">
                
                <label for="carInsurance">Car Insurance ($):</label>
                <input type="number" id="carInsurance" value="135" min="0" onchange="updateAnnualExpenses()">
                
                <label for="motoInsurance">Motorcycle Insurance ($):</label>
                <input type="number" id="motoInsurance" value="40" min="0" onchange="updateAnnualExpenses()">
                
                <label for="groceries">Groceries ($):</label>
                <input type="number" id="groceries" value="860" min="0" onchange="updateAnnualExpenses()">
                
                <label for="gas">Gas ($):</label>
                <input type="number" id="gas" value="100" min="0" onchange="updateAnnualExpenses()">
                
                <label for="phone">Phone ($):</label>
                <input type="number" id="phone" value="100" min="0" onchange="updateAnnualExpenses()">
                
                <label for="utilities">Utilities ($):</label>
                <input type="number" id="utilities" value="150" min="0" onchange="updateAnnualExpenses()">
                
                <label for="carLoan">Car Loan ($):</label>
                <input type="number" id="carLoan" value="550" min="0" onchange="updateAnnualExpenses()">
                
                <label for="homeLoan">Home Loan ($):</label>
                <input type="number" id="homeLoan" value="364" min="0" onchange="updateAnnualExpenses()">
                
                <h4 style="margin: 15px 0 10px 0; color: #666;">Non-Essential Monthly Expenses</h4>
                
                <label for="entertainment">Entertainment ($):</label>
                <input type="number" id="entertainment" value="0" min="0" onchange="updateAnnualExpenses()">
                
                <label for="diningOut">Dining Out ($):</label>
                <input type="number" id="diningOut" value="0" min="0" onchange="updateAnnualExpenses()">
                
                <label for="hobbies">Hobbies ($):</label>
                <input type="number" id="hobbies" value="0" min="0" onchange="updateAnnualExpenses()">
                
                <label for="shopping">Shopping ($):</label>
                <input type="number" id="shopping" value="0" min="0" onchange="updateAnnualExpenses()">
                
                <label for="travel">Travel ($):</label>
                <input type="number" id="travel" value="0" min="0" onchange="updateAnnualExpenses()">
                
                <label for="miscNonEssential">Miscellaneous ($):</label>
                <input type="number" id="miscNonEssential" value="0" min="0" onchange="updateAnnualExpenses()">
                
                <h4 style="margin: 15px 0 10px 0; color: #666;">Calculated Totals</h4>
                
                <label for="essentialMonthly">Essential Monthly Total ($):</label>
                <input type="number" id="essentialMonthly" value="4415" min="1000" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                
                <label for="nonEssentialMonthly">Non-Essential Monthly Total ($):</label>
                <input type="number" id="nonEssentialMonthly" value="0" min="0" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                
                <label for="currentExpenses">Current Annual Expenses ($):</label>
                <input type="number" id="currentExpenses" value="52980" min="20000" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                
                <label for="expenseInflation">Expense Inflation (%):</label>
                <input type="number" id="expenseInflation" value="3" step="0.1" min="0" max="10">
            </div>
            
            <div class="input-group">
                <h3>Current Balances</h3>
                <label for="retirementBalance">Retirement Accounts ($):</label>
                <input type="number" id="retirementBalance" value="560183" min="0">
                
                <label for="taxableBalance">Taxable Accounts ($):</label>
                <input type="number" id="taxableBalance" value="124112" min="0">
                
                <label for="cashBalance">Cash Balance ($):</label>
                <input type="number" id="cashBalance" value="76000" min="0">
                
                <label for="investmentReturn">Investment Return (%):</label>
                <input type="number" id="investmentReturn" value="6" step="0.1" min="3" max="12">
                
                <label for="cashReturn">Cash Return (%):</label>
                <input type="number" id="cashReturn" value="3.98" step="0.01" min="0" max="8">
            </div>
            
            <div class="input-group">
                <h3>Tax Settings</h3>
                <label for="taxRate">Effective Tax Rate (%):</label>
                <input type="number" id="taxRate" value="22" step="1" min="10" max="40">
            </div>
        </div>
        
        <button onclick="updateCurrentHourlyRate(); updateAnnualExpenses(); calculateProjection();">Calculate Projection</button>
        
        <div id="summary" class="summary" style="display: none;">
            <h3>Summary</h3>
            <div id="summaryContent"></div>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        function calculateACASubsidy(afterTaxIncome) {
            // 2025 Federal Poverty Level for 1 person
            const fpl2025 = 15060;
            
            // Estimated benchmark premium for Utah individual coverage (monthly)
            const benchmarkPremiumMonthly = 450;
            const benchmarkPremiumAnnual = benchmarkPremiumMonthly * 12;
            
            // Calculate income as percentage of FPL
            const incomePercentFPL = (afterTaxIncome / fpl2025) * 100;
            
            // No subsidy if income is below 100% FPL or above 400% FPL
            if (incomePercentFPL < 100 || incomePercentFPL > 400) {
                return 0;
            }
            
            // Applicable percentage based on income level (2025 ACA rates)
            let applicablePercentage;
            if (incomePercentFPL <= 150) {
                applicablePercentage = 0.0285; // 2.85%
            } else if (incomePercentFPL <= 200) {
                applicablePercentage = 0.0570; // 5.70%
            } else if (incomePercentFPL <= 250) {
                applicablePercentage = 0.0855; // 8.55%
            } else if (incomePercentFPL <= 300) {
                applicablePercentage = 0.1140; // 11.40%
            } else {
                // Linear interpolation from 11.40% at 300% FPL to ~9.5% at 400% FPL
                const percentAbove300 = (incomePercentFPL - 300) / 100;
                applicablePercentage = 0.1140 - (percentAbove300 * 0.019);
            }
            
            // Calculate expected premium contribution
            const expectedContribution = afterTaxIncome * applicablePercentage;
            
            // Subsidy is benchmark premium minus expected contribution
            const subsidy = Math.max(0, benchmarkPremiumAnnual - expectedContribution);
            
            return Math.round(subsidy);
        }
        
        function calculateUnemploymentBenefits(currentYearW2, priorYearW2) {
            // Base period earnings = current year + prior year W2 income
            const totalBasePeriodEarnings = currentYearW2 + priorYearW2;
            
            // Highest quarter earnings (assume current year W2 / 4 for simplicity)
            const highestQuarterEarnings = Math.max(currentYearW2 / 4, priorYearW2 / 4);
            
            // Eligibility Check 1: total_base_period_earnings >= $5,300
            if (totalBasePeriodEarnings < 5300) {
                return 0; // Not eligible
            }
            
            // Eligibility Check 2: total_base_period_earnings >= (highest_quarter_earnings √ó 1.5)
            if (totalBasePeriodEarnings < (highestQuarterEarnings * 1.5)) {
                return 0; // Not eligible
            }
            
            // Weekly Benefit Amount: (highest_quarter_earnings √∑ 26) - 5
            let weeklyBenefit = (highestQuarterEarnings / 26) - 5;
            weeklyBenefit = Math.round(weeklyBenefit); // Round to nearest whole dollar
            weeklyBenefit = Math.min(weeklyBenefit, 777); // Apply Utah 2025 maximum cap
            
            if (weeklyBenefit <= 0) {
                return 0; // No benefit if calculation results in zero or negative
            }
            
            // Duration: (total_base_period_earnings √ó 0.27) √∑ weekly_benefit_amount
            let durationWeeks = (totalBasePeriodEarnings * 0.27) / weeklyBenefit;
            durationWeeks = Math.floor(durationWeeks); // Round DOWN to whole weeks
            durationWeeks = Math.max(10, Math.min(26, durationWeeks)); // Apply min 10, max 26 weeks
            
            // Total annual unemployment benefits
            return weeklyBenefit * durationWeeks;
        }
        
        function updatePTOPayout() {
            const annualHours = parseInt(document.getElementById('annualHours').value) || 0;
            const currentHourlyRate = parseFloat(document.getElementById('currentHourlyRate').value) || 0;
            const ptoHours = Math.floor(annualHours / 30);
            const ptoPayout = ptoHours * currentHourlyRate;
            document.getElementById('ptoPayout').value = ptoPayout.toFixed(2);
        }
        
        function updateCurrentHourlyRate() {
            const rrchHours = parseInt(document.getElementById('startingCareerHours').value) || 0;
            const currentRate = calculateHourlyRate(rrchHours, 0); // 0 years from base (current rate)
            document.getElementById('currentHourlyRate').value = currentRate.toFixed(2);
            updatePTOPayout(); // Update PTO payout when hourly rate changes
        }
        
        function updateAnnualExpenses() {
            // Essential expenses
            const rent = parseFloat(document.getElementById('rent').value) || 0;
            const pets = parseFloat(document.getElementById('pets').value) || 0;
            const subscriptions = parseFloat(document.getElementById('subscriptions').value) || 0;
            const carInsurance = parseFloat(document.getElementById('carInsurance').value) || 0;
            const motoInsurance = parseFloat(document.getElementById('motoInsurance').value) || 0;
            const groceries = parseFloat(document.getElementById('groceries').value) || 0;
            const gas = parseFloat(document.getElementById('gas').value) || 0;
            const phone = parseFloat(document.getElementById('phone').value) || 0;
            const utilities = parseFloat(document.getElementById('utilities').value) || 0;
            const carLoan = parseFloat(document.getElementById('carLoan').value) || 0;
            const homeLoan = parseFloat(document.getElementById('homeLoan').value) || 0;
            
            // Non-essential expenses
            const entertainment = parseFloat(document.getElementById('entertainment').value) || 0;
            const diningOut = parseFloat(document.getElementById('diningOut').value) || 0;
            const hobbies = parseFloat(document.getElementById('hobbies').value) || 0;
            const shopping = parseFloat(document.getElementById('shopping').value) || 0;
            const travel = parseFloat(document.getElementById('travel').value) || 0;
            const miscNonEssential = parseFloat(document.getElementById('miscNonEssential').value) || 0;
            
            // Calculate totals
            const essentialTotal = rent + pets + subscriptions + carInsurance + motoInsurance + 
                                 groceries + gas + phone + utilities + carLoan + homeLoan;
            const nonEssentialTotal = entertainment + diningOut + hobbies + shopping + travel + miscNonEssential;
            const totalMonthly = essentialTotal + nonEssentialTotal;
            const totalAnnual = totalMonthly * 12;
            
            // Update calculated fields
            document.getElementById('essentialMonthly').value = essentialTotal.toFixed(0);
            document.getElementById('nonEssentialMonthly').value = nonEssentialTotal.toFixed(0);
            document.getElementById('currentExpenses').value = totalAnnual.toFixed(0);
        }
        
        function determineStep(rrchHours) {
            if (rrchHours <= 699) return 1;
            if (rrchHours <= 1399) return 2;
            if (rrchHours <= 2099) return 3;
            if (rrchHours <= 3499) return 4;
            if (rrchHours <= 4899) return 5;
            if (rrchHours <= 6299) return 6;
            if (rrchHours <= 7699) return 7;
            if (rrchHours <= 9099) return 8;
            if (rrchHours <= 10499) return 9;
            if (rrchHours <= 11899) return 10;
            if (rrchHours <= 13299) return 11;
            if (rrchHours <= 14699) return 12;
            return 13; // 14,700+
        }
        
        function calculateHourlyRate(rrchHours, yearsFromBase) {
            // 2025 base rates from pay scale
            const payScale2025 = {
                1: 19.76,
                2: 19.97,
                3: 20.18,
                4: 20.80,
                5: 21.63,
                6: 22.62,
                7: 23.62,
                8: 25.40,
                9: 27.45,
                10: 28.98,
                11: 30.73,
                12: 33.19,
                13: 38.50
            };
            
            const step = determineStep(rrchHours);
            const baseRate = payScale2025[step];
            // Apply 4% annual increases to the base rate
            const adjustedRate = baseRate * Math.pow(1.04, yearsFromBase);
            return adjustedRate;
        }
        
        function calculateHourlyRateOld(careerHours, baseRate, yearsWorked, annualRaise) {
            // This is the old simplified version - keeping for reference but not used
            let adjustedRate = baseRate * Math.pow(1 + annualRaise/100, yearsWorked);
            
            if (careerHours >= 20000) adjustedRate *= 1.15;
            else if (careerHours >= 15000) adjustedRate *= 1.10;
            else if (careerHours >= 12000) adjustedRate *= 1.06;
            else if (careerHours >= 10000) adjustedRate *= 1.03;
            
            return adjustedRate;
        }
        
        function calculateProjection() {
            // Set any empty fields to 0
            const fields = [
                'currentAge', 'endAge', 'startingCareerHours', 'annualHours', 'startingProfitSharing',
                'currentHourlyRate', 'annualRaise', 'profitSharingPercent', 'ptoPayout', 'otherIncome', 'partnerIncome',
                'rent', 'pets', 'subscriptions', 'carInsurance', 'motoInsurance', 'groceries', 'gas', 'phone', 'utilities', 'carLoan', 'homeLoan',
                'entertainment', 'diningOut', 'hobbies', 'shopping', 'travel', 'miscNonEssential',
                'essentialMonthly', 'nonEssentialMonthly', 'currentExpenses', 'expenseInflation',
                'retirementBalance', 'taxableBalance', 'cashBalance', 'investmentReturn', 'cashReturn', 'taxRate'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value || isNaN(parseFloat(field.value))) {
                    field.value = 0;
                }
            });
            
            // Get input values
            const currentAge = parseInt(document.getElementById('currentAge').value);
            const endAge = parseInt(document.getElementById('endAge').value);
            const startingCareerHours = parseInt(document.getElementById('startingCareerHours').value);
            const annualHours = parseInt(document.getElementById('annualHours').value);
            const startingProfitSharing = parseFloat(document.getElementById('startingProfitSharing').value);
            const currentHourlyRate = parseFloat(document.getElementById('currentHourlyRate').value);
            const annualRaise = parseFloat(document.getElementById('annualRaise').value);
            const profitSharingPercent = parseFloat(document.getElementById('profitSharingPercent').value);
            const otherIncome = parseFloat(document.getElementById('otherIncome').value);
            const partnerIncome = parseFloat(document.getElementById('partnerIncome').value);
            const partnerAnnualIncome = partnerIncome * 12;
            const currentExpenses = parseFloat(document.getElementById('currentExpenses').value);
            const expenseInflation = parseFloat(document.getElementById('expenseInflation').value);
            const retirementBalance = parseFloat(document.getElementById('retirementBalance').value);
            const taxableBalance = parseFloat(document.getElementById('taxableBalance').value);
            const cashBalance = parseFloat(document.getElementById('cashBalance').value);
            const investmentReturn = parseFloat(document.getElementById('investmentReturn').value);
            const cashReturn = parseFloat(document.getElementById('cashReturn').value);
            const taxRate = parseFloat(document.getElementById('taxRate').value);
            
            let results = [];
            let currentCash = cashBalance;
            let currentTaxable = taxableBalance;
            let currentRetirement = retirementBalance;
            let cashDepleted = false;
            let taxableDepleted = false;
            let priorYearW2 = 0; // For profit sharing calculation
            let priorYearIncome = 0; // For ACA tax refund calculation
            
            for (let age = currentAge; age <= endAge; age++) {
                const yearsWorked = age - currentAge;
                const rrchHours = startingCareerHours + (yearsWorked * annualHours);
                const step = determineStep(rrchHours);
                const hourlyRate = calculateHourlyRate(rrchHours, yearsWorked);
                const seasonalW2 = hourlyRate * annualHours;
                
                // Calculate PTO payout: 1 hour of PTO per 30 hours worked
                const ptoHours = Math.floor(annualHours / 30);
                const ptoPayout = ptoHours * hourlyRate;
                
                // Calculate unemployment benefits based on work history
                const unemploymentBenefits = calculateUnemploymentBenefits(seasonalW2, priorYearW2);
                
                // Profit sharing is based on prior year W2 income
                let profitShare = 0;
                if (age === currentAge) {
                    profitShare = startingProfitSharing; // Use starting amount for first year
                } else {
                    profitShare = priorYearW2 * (profitSharingPercent / 100);
                }
                
                // 401k contribution is 3% of profit sharing
                const contribution401k = profitShare * 0.03;
                
                // Calculate total work income (W2 + Profit Share + PTO)
                const totalWorkIncome = seasonalW2 + profitShare + ptoPayout;
                
                const totalGrossIncome = totalWorkIncome + otherIncome + unemploymentBenefits;
                const afterTaxIncome = totalGrossIncome * (1 - taxRate / 100);
                
                // ACA tax refund based on PRIOR year income (received in current year)
                let acaTaxRefund = 0;
                if (age > currentAge) {
                    acaTaxRefund = calculateACASubsidy(priorYearIncome);
                }
                
                const totalHouseholdIncome = afterTaxIncome + partnerAnnualIncome + acaTaxRefund;
                const annualExpenses = currentExpenses * Math.pow(1 + expenseInflation/100, yearsWorked);
                const shortfall = annualExpenses - totalHouseholdIncome;
                
                // Update account balances
                if (!cashDepleted) {
                    currentCash = currentCash * (1 + cashReturn/100);
                    if (shortfall > 0) {
                        if (currentCash >= shortfall) {
                            currentCash -= shortfall;
                        } else {
                            currentCash = 0;
                            cashDepleted = true;
                        }
                    } else {
                        currentCash += Math.abs(shortfall); // Add surplus to cash
                    }
                }
                
                if (cashDepleted && !taxableDepleted) {
                    currentTaxable = currentTaxable * (1 + investmentReturn/100);
                    if (shortfall > 0) {
                        if (currentTaxable >= shortfall) {
                            currentTaxable -= shortfall;
                        } else {
                            currentTaxable = 0;
                            taxableDepleted = true;
                        }
                    }
                } else if (!cashDepleted) {
                    currentTaxable = currentTaxable * (1 + investmentReturn/100);
                }
                
                currentRetirement = currentRetirement * (1 + investmentReturn/100) + contribution401k;
                
                results.push({
                    age: age,
                    rrchHours: rrchHours > 14700 ? "----" : rrchHours.toLocaleString(),
                    step: step,
                    hourlyRate: hourlyRate.toFixed(2),
                    seasonalW2: seasonalW2.toFixed(0),
                    otherIncome: otherIncome.toFixed(0),
                    profitShare: profitShare.toFixed(0),
                    ptoPayout: ptoPayout.toFixed(0),
                    totalWorkIncome: totalWorkIncome.toFixed(0),
                    unemploymentBenefits: unemploymentBenefits.toFixed(0),
                    contribution401k: contribution401k.toFixed(0),
                    totalIncome: totalGrossIncome.toFixed(0),
                    afterTaxIncome: afterTaxIncome.toFixed(0),
                    acaTaxRefund: acaTaxRefund.toFixed(0),
                    partnerIncome: partnerAnnualIncome.toFixed(0),
                    annualExpenses: annualExpenses.toFixed(0),
                    shortfall: shortfall.toFixed(0),
                    cashBalance: currentCash.toFixed(0),
                    taxableBalance: currentTaxable.toFixed(0),
                    retirementBalance: currentRetirement.toFixed(0),
                    totalNetWorth: (currentCash + currentTaxable + currentRetirement).toFixed(0)
                });
                
                // Set prior year values for next iteration
                priorYearW2 = seasonalW2;
                priorYearIncome = afterTaxIncome;
            }
            
            displayResults(results);
            displaySummary(results);
        }
        
        function displayResults(results) {
            let html = '<table>';
            html += '<tr><th>Age</th><th>Work Income</th><th>Unemployment Benefits</th><th>After-Tax</th><th>ACA Tax Refund</th><th>Partner Income</th><th>Expenses</th><th>Shortfall</th><th>Cash</th><th>Taxable</th><th>Retirement</th><th>Net Worth</th></tr>';
            
            results.forEach(row => {
                const shortfallClass = parseFloat(row.shortfall) > 0 ? 'negative' : 'positive';
                const cashClass = parseFloat(row.cashBalance) <= 0 ? 'negative' : '';
                const taxableClass = parseFloat(row.taxableBalance) <= 0 ? 'negative' : '';
                
                html += `<tr>
                    <td>${row.age}</td>
                    <td class="work-income">
                        $${parseInt(row.totalWorkIncome).toLocaleString()}
                        <div class="tooltip">
                            Hourly Rate: $${row.hourlyRate}<br>
                            W2 Income: $${parseInt(row.seasonalW2).toLocaleString()}<br>
                            Profit Share: $${parseInt(row.profitShare).toLocaleString()}<br>
                            PTO Payout: $${parseInt(row.ptoPayout).toLocaleString()}
                        </div>
                    </td>
                    <td>$${parseInt(row.unemploymentBenefits).toLocaleString()}</td>
                    <td>$${parseInt(row.afterTaxIncome).toLocaleString()}</td>
                    <td class="positive">$${parseInt(row.acaTaxRefund).toLocaleString()}</td>
                    <td>$${parseInt(row.partnerIncome).toLocaleString()}</td>
                    <td>$${parseInt(row.annualExpenses).toLocaleString()}</td>
                    <td class="${shortfallClass}">$${parseInt(row.shortfall).toLocaleString()}</td>
                    <td class="${cashClass}">$${parseInt(row.cashBalance).toLocaleString()}</td>
                    <td class="${taxableClass}">$${parseInt(row.taxableBalance).toLocaleString()}</td>
                    <td class="retirement-cell">
                        $${parseInt(row.retirementBalance).toLocaleString()}
                        <div class="tooltip">
                            Annual 401k Contribution: $${parseInt(row.contribution401k).toLocaleString()}<br>
                            (3% of Profit Sharing)
                        </div>
                    </td>
                    <td class="positive">$${parseInt(row.totalNetWorth).toLocaleString()}</td>
                </tr>`;
            });
            html += '</table>';
            
            document.getElementById('results').innerHTML = html;
        }
        
        function displaySummary(results) {
            const firstYear = results[0];
            const lastYear = results[results.length - 1];
            const cashDepletedAge = results.find(r => parseFloat(r.cashBalance) <= 0)?.age || 'Never';
            const taxableDepletedAge = results.find(r => parseFloat(r.taxableBalance) <= 0)?.age || 'Never';
            
            const summaryHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div>
                        <strong>Wage Growth:</strong><br>
                        $${firstYear.hourlyRate} ‚Üí $${lastYear.hourlyRate}/hour<br>
                        ${((parseFloat(lastYear.hourlyRate) / parseFloat(firstYear.hourlyRate) - 1) * 100).toFixed(1)}% increase
                    </div>
                    <div>
                        <strong>Account Depletion:</strong><br>
                        Cash: Age ${cashDepletedAge}<br>
                        Taxable: Age ${taxableDepletedAge}
                    </div>
                    <div>
                        <strong>Final Net Worth:</strong><br>
                        $${parseInt(lastYear.totalNetWorth).toLocaleString()}<br>
                        (Age ${lastYear.age})
                    </div>
                    <div>
                        <strong>Final Annual Shortfall:</strong><br>
                        $${parseInt(lastYear.shortfall).toLocaleString()}<br>
                        ${parseFloat(lastYear.shortfall) > 0 ? '(Needs additional income)' : '(Surplus)'}
                    </div>
                </div>
            `;
            
            document.getElementById('summaryContent').innerHTML = summaryHTML;
            document.getElementById('summary').style.display = 'block';
        }
        
        // Calculate initial projection on page load
        window.onload = function() {
            updateCurrentHourlyRate();
            updatePTOPayout();
            updateAnnualExpenses();
            calculateProjection();
        };
    </script>
</body>
</html>